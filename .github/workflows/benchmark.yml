name: PR Benchmarks

on:
  push:
    branches: ["**"]
    #branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  benchmark_pr:
    name: Compare Test Computation Time (PR vs Main)
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      OMPI_ALLOW_RUN_AS_ROOT: 1
      OMPI_MCA_btl_vader_single_copy_mechanism: none
      IBLGF_MPI_NP: 4
      ALLOWED_SLOWDOWN: "1.05"  # 5% slowdown allowed

    steps:
      - name: Checkout base commit (main side)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          path: base

      - name: Checkout PR head commit (incoming)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          path: head

      - name: Prepare Scripts
        run: |
          chmod +x base/*.sh
          chmod +x head/*.sh

      - name: Benchmark base commit
        run: |
          set -euo pipefail
          cd base

          ./docker_iblgf.sh -c 4 -- bash -lc './iblgf.sh run-test ns_amr_lgf configFile_0 --bench -n 4' \
            | tee ../bench_base_ns.full.txt
          tail -n 1 ../bench_base_ns.full.txt > ../bench_base_ns.txt

          ./docker_iblgf.sh -c 4 -- bash -lc './iblgf.sh run-test poisson config_1_lv_0 --bench -n 4' \
            | tee ../bench_base_poisson.full.txt
          tail -n 1 ../bench_base_poisson.full.txt > ../bench_base_poisson.txt

          echo "Base times:"
          cat ../bench_base_ns.txt
          cat ../bench_base_poisson.txt

      - name: Benchmark PR head commit
        run: |
          set -euo pipefail
          cd head

          ./docker_iblgf.sh -c 4 -- bash -lc './iblgf.sh run-test ns_amr_lgf configFile_0 --bench -n 4' \
            | tee ../bench_head_ns.full.txt
          tail -n 1 ../bench_head_ns.full.txt > ../bench_head_ns.txt

          ./docker_iblgf.sh -c 4 -- bash -lc './iblgf.sh run-test poisson config_1_lv_0 --bench -n 4' \
            | tee ../bench_head_poisson.full.txt
          tail -n 1 ../bench_head_poisson.full.txt > ../bench_head_poisson.txt

          echo "Head times:"
          cat ../bench_head_ns.txt
          cat ../bench_head_poisson.txt

      - name: Compare and enforce slowdown threshold
        run: |
          python3 - << 'PY'
          import os, sys

          allowed = float(os.environ["ALLOWED_SLOWDOWN"])

          def read_float(path):
            s = open(path, "r", encoding="utf-8").read().strip()
            try:
              return float(s)
            except ValueError:
              raise SystemExit(f"Expected a single float in {path}, got:\n{s}")

          cases = [
            ("ns_amr_lgf", "bench_base_ns.txt", "bench_head_ns.txt"),
            ("poisson", "bench_base_poisson.txt", "bench_head_poisson.txt"),
          ]

          failed = False
          print("\n=== PR Benchmark Comparison ===")
          for name, basef, headf in cases:
            base_t = read_float(basef)
            head_t = read_float(headf)
            ratio = head_t / base_t if base_t > 0 else float("inf")
            pct = (ratio - 1.0) * 100.0
            print(f"{name:10s} base={base_t:.3f}s  head={head_t:.3f}s  ratio={ratio:.3f}  ({pct:+.1f}%)")
            if ratio > allowed:
              failed = True

          print(f"\nAllowed slowdown ratio: {allowed:.3f}")
          if failed:
            print("Benchmark regression detected.")
            sys.exit(1)
          else:
            print("Benchmarks within threshold.")
          PY

      - name: Upload benchmark logs
        uses: actions/upload-artifact@v4
        with:
          name: bench-logs
          path: |
            bench_*.txt
            bench_*.full.txt
              

            